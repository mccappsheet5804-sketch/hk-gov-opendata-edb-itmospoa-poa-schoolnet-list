<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小一入學統籌辦法學校網範圍查詢系統</title>
    <!-- 數據來源：https://data.gov.hk/tc-data/dataset/hk-edb-itmospoa-poa-schoolnet-list -->
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin="anonymous">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body, html {
            height: 100%;
            font-family: 'Microsoft JhengHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
        }
        
        .container {
            display: flex;
            height: 100%;
            width: 100%;
        }
        
        /* 手風琴控制面板樣式 */
        .accordion-panel {
            width: 350px;
            background-color: #ffffff;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .panel-header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .panel-header h1 {
            font-size: 1.4rem;
            margin-bottom: 5px;
        }
        
        .panel-header p {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .accordion-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .accordion-section {
            margin-bottom: 10px;
            border-radius: 5px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }
        
        .accordion-header {
            background-color: #3498db;
            color: white;
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s;
        }
        
        .accordion-header:hover {
            background-color: #2980b9;
        }
        
        .accordion-header.active {
            background-color: #2c3e50;
        }
        
        .accordion-content {
            background-color: white;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .accordion-content.open {
            max-height: 500px;
        }
        
        .layer-control {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .layer-control:last-child {
            border-bottom: none;
        }
        
        .layer-title {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
        }
        
        .layer-title i {
            margin-right: 8px;
            color: #3498db;
        }
        
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .checkbox-container input {
            margin-right: 8px;
        }
        
        .slider-container {
            margin-top: 10px;
        }
        
        .slider-container label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #666;
        }
        
        .slider {
            width: 100%;
            height: 5px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .legend-swatch {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 3px;
        }
        
        .map-controls {
            padding: 15px;
            background-color: #f9f9f9;
            border-top: 1px solid #e0e0e0;
        }
        
        .btn {
            display: block;
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn i {
            margin-right: 8px;
        }
        
        /* 地圖容器樣式 */
        .map-container {
            flex: 1;
            height: 100%;
            position: relative;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .map-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-size: 0.9rem;
            z-index: 1000;
            max-width: 300px;
        }
        
        .feature-count {
            margin-top: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        /* 響應式設計 */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .accordion-panel {
                width: 100%;
                height: 40%;
                border-right: none;
                border-bottom: 1px solid #ddd;
            }
            
            .map-container {
                height: 60%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 手風琴控制面板 -->
        <div class="accordion-panel">
            <div class="panel-header">
                <h1><i class="fas fa-map"></i> 小一入學學校網查詢系統</h1>
                <p>香港教育局小一入學統籌辦法學校網範圍</p>
            </div>
            
            <div class="accordion-container" id="accordionContainer">
                <!-- 底圖選擇部分 -->
                <div class="accordion-section">
                    <div class="accordion-header active" data-section="baseMaps">
                        <span><i class="fas fa-layer-group"></i> 底圖選擇</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="accordion-content open" id="baseMapsContent">
                        <div class="layer-control">
                            <div class="layer-title">
                                <i class="fas fa-globe"></i> OpenStreetMap
                            </div>
                            <div class="checkbox-container">
                                <input type="radio" name="baseMap" id="osmMap" checked>
                                <label for="osmMap">標準街道地圖</label>
                            </div>
                            <div class="legend-item">
                                <div class="legend-swatch" style="background-color: #2c3e50;"></div>
                                <span>道路及建築物</span>
                            </div>
                        </div>
                        
                        <div class="layer-control">
                            <div class="layer-title">
                                <i class="fas fa-mountain"></i> 地形圖
                            </div>
                            <div class="checkbox-container">
                                <input type="radio" name="baseMap" id="topoMap">
                                <label for="topoMap">地形圖（含等高線）</label>
                            </div>
                            <div class="legend-item">
                                <div class="legend-swatch" style="background-color: #4a6fa5;"></div>
                                <span>水域</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-swatch" style="background-color: #4d7c3a;"></div>
                                <span>植被區域</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 學校網數據部分 -->
                <div class="accordion-section">
                    <div class="accordion-header" data-section="wfsData">
                        <span><i class="fas fa-database"></i> 學校網數據圖層</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="accordion-content" id="wfsDataContent">
                        <div class="layer-control">
                            <div class="layer-title">
                                <i class="fas fa-school"></i> 小一學校網範圍
                            </div>
                            <div class="checkbox-container">
                                <input type="checkbox" id="wfsLayer" checked>
                                <label for="wfsLayer">顯示學校網範圍</label>
                            </div>
                            
                            <div class="slider-container">
                                <label for="opacitySlider">圖層透明度: <span id="opacityValue">0.7</span></label>
                                <input type="range" min="0" max="1" step="0.1" value="0.7" class="slider" id="opacitySlider">
                            </div>
                            
                            <div style="margin-top: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #666;">圖例說明:</label>
                                <div class="legend-item">
                                    <div class="legend-swatch" style="background-color: #e74c3c;"></div>
                                    <span>學校位置（點）</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-swatch" style="background-color: #3498db;"></div>
                                    <span>學校網範圍（多邊形）</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-swatch" style="background-color: #2ecc71;"></div>
                                    <span>邊界線（線）</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="layer-control">
                            <div class="layer-title">
                                <i class="fas fa-filter"></i> 數據篩選
                            </div>
                            <div style="margin-top: 10px;">
                                <label for="maxFeatures" style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #666;">最大顯示數量:</label>
                                <select id="maxFeatures" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                                    <option value="10">10個學校網</option>
                                    <option value="25">25個學校網</option>
                                    <option value="50" selected>50個學校網</option>
                                    <option value="100">100個學校網</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 地圖控制部分 -->
                <div class="accordion-section">
                    <div class="accordion-header" data-section="mapControls">
                        <span><i class="fas fa-sliders-h"></i> 地圖控制</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="accordion-content" id="mapControlsContent">
                        <div class="layer-control">
                            <button class="btn" id="zoomToData">
                                <i class="fas fa-search-location"></i> 縮放至數據範圍
                            </button>
                            
                            <button class="btn" id="refreshData">
                                <i class="fas fa-sync-alt"></i> 重新載入數據
                            </button>
                            
                            <button class="btn" id="toggleLegend">
                                <i class="fas fa-eye"></i> 顯示/隱藏圖例
                            </button>
                            
                            <div style="margin-top: 15px;">
                                <label for="mapStyle" style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #666;">地圖主題:</label>
                                <select id="mapStyle" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                                    <option value="light">淺色主題</option>
                                    <option value="dark">深色主題</option>
                                    <option value="satellite">衛星影像</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="map-controls">
                <div class="feature-count">
                    <i class="fas fa-info-circle"></i> 已載入學校網: <span id="featureCount">0</span> 個
                </div>
                <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                    數據來源: 香港教育局小一入學統籌辦法
                </div>
            </div>
        </div>
        
        <!-- 地圖容器 -->
        <div class="map-container">
            <div id="map"></div>
            <div class="map-info">
                <strong>小一學校網範圍查詢系統</strong>
                <div class="feature-count" id="liveFeatureCount">正在載入數據...</div>
                <div style="font-size: 0.8rem; color: #666;">
                    點擊學校網範圍查看詳細資訊
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin="anonymous"></script>
    
    <!-- jQuery for simpler AJAX and DOM manipulation -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    
    <script>
        // 初始化地圖
        var map = L.map('map').setView([22.3193, 114.1694], 11); // 香港坐標
        
        // 底圖圖層
        var osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> 貢獻者'
        }).addTo(map);
        
        var topoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            attribution: '地圖數據: © OpenStreetMap 貢獻者, SRTM | 地圖樣式: © OpenTopoMap (CC-BY-SA)'
        });
        
        // 圖層組
        var baseLayers = {
            "OpenStreetMap": osmLayer,
            "地形圖": topoLayer
        };
        
        var wfsLayer = L.geoJSON(null, {
            pointToLayer: function(feature, latlng) {
                // 將點要素樣式設為圓形標記
                return L.circleMarker(latlng, {
                    radius: 8,
                    fillColor: '#e74c3c',
                    color: '#c0392b',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.7
                });
            },
            style: function(feature) {
                // 不同幾何類型的樣式
                var geometryType = feature.geometry.type;
                var color = '#3498db'; // 多邊形默認顏色
                
                if (geometryType === 'Point' || geometryType === 'MultiPoint') {
                    color = '#e74c3c';
                } else if (geometryType === 'LineString' || geometryType === 'MultiLineString') {
                    color = '#2ecc71';
                }
                
                return {
                    color: color,
                    weight: 2,
                    opacity: 0.7,
                    fillOpacity: 0.3
                };
            },
            onEachFeature: function(feature, layer) {
                // 添加彈出窗口顯示要素屬性
                if (feature.properties) {
                    var popupContent = '<div style="font-weight: bold; margin-bottom: 10px;">學校網資訊</div>';
                    
                    // 檢查常見的學校網屬性名稱
                    var schoolNet = feature.properties.SCHOOLNET || featureProperties.schoolnet || featureProperties.net_code || '未提供';
                    var district = feature.properties.DISTRICT || featureProperties.district || featureProperties.region || '未提供';
                    var description = feature.properties.DESCRIPTIO || featureProperties.description || featureProperties.name_zh || '未提供';
                    
                    popupContent += '<div style="margin-bottom: 8px;"><strong>學校網編號:</strong> ' + schoolNet + '</div>';
                    popupContent += '<div style="margin-bottom: 8px;"><strong>地區:</strong> ' + district + '</div>';
                    popupContent += '<div style="margin-bottom: 8px;"><strong>描述:</strong> ' + description + '</div>';
                    
                    // 添加其他屬性
                    popupContent += '<hr style="margin: 10px 0;"><div style="font-size: 0.9rem; color: #666;">其他屬性:</div>';
                    popupContent += '<ul style="margin: 5px 0; padding-left: 15px; font-size: 0.85rem;">';
                    
                    var propertyCount = 0;
                    for (var key in feature.properties) {
                        if (feature.properties.hasOwnProperty(key) && propertyCount < 5) {
                            // 跳過已顯示的屬性
                            if (key !== 'SCHOOLNET' && key !== 'DISTRICT' && key !== 'DESCRIPTIO' && 
                                key !== 'schoolnet' && key !== 'district' && key !== 'description') {
                                popupContent += '<li><strong>' + key + ':</strong> ' + feature.properties[key] + '</li>';
                                propertyCount++;
                            }
                        }
                    }
                    
                    popupContent += '</ul>';
                    
                    if (feature.geometry) {
                        popupContent += '<div style="margin-top: 8px; font-size: 0.8rem; color: #888;"><strong>幾何類型:</strong> ' + feature.geometry.type + '</div>';
                    }
                    
                    layer.bindPopup(popupContent);
                }
            }
        }).addTo(map);
        
        // 存儲當前WFS URL
        var currentWfsUrl = 'https://portal.csdi.gov.hk/server/services/common/edb_rcd_1633320960920_77011/MapServer/WFSServer?service=wfs&request=GetFeature&typenames=edb_poa__poa&outputFormat=geojson&maxFeatures=50';
        
        // 函數：獲取WFS數據
        function fetchWFSData(url) {
            $('#liveFeatureCount').text('正在載入數據...');
            
            // 使用jQuery AJAX獲取GeoJSON數據
            $.ajax({
                url: url,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    // 清除現有要素
                    wfsLayer.clearLayers();
                    
                    // 添加新要素
                    wfsLayer.addData(data);
                    
                    // 更新要素計數
                    var featureCount = 0;
                    if (data.features) {
                        featureCount = data.features.length;
                    }
                    
                    $('#featureCount').text(featureCount);
                    $('#liveFeatureCount').text('已載入 ' + featureCount + ' 個學校網');
                    
                    // 如果有要素，更新地圖信息
                    if (featureCount > 0) {
                        $('#liveFeatureCount').html('<i class="fas fa-check-circle" style="color: #27ae60;"></i> 已載入 ' + featureCount + ' 個學校網');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('獲取WFS數據時出錯:', error);
                    $('#liveFeatureCount').html('<i class="fas fa-exclamation-triangle" style="color: #e74c3c;"></i> 載入數據時出錯');
                    
                    // 備用：如果遠程服務器失敗，嘗試使用本地樣本數據
                    // loadSampleData();
                    // window.open("https://api.allorigins.win/get?url=", "_href");
                }
            });
        }
        
        // 備用函數：載入樣本數據
        function loadSampleData() {
            var sampleData = {
                "type": "FeatureCollection",
                "features": [
                    {
                        "type": "Feature",
                        "properties": {
                            "SCHOOLNET": "11",
                            "DISTRICT": "中西區",
                            "DESCRIPTIO": "中西區學校網",
                            "學校數量": "15"
                        },
                        "geometry": {
                            "type": "Polygon",
                            "coordinates": [[
                                [114.15, 22.28], [114.16, 22.28], 
                                [114.16, 22.29], [114.15, 22.29], 
                                [114.15, 22.28]
                            ]]
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "SCHOOLNET": "12",
                            "DISTRICT": "灣仔區",
                            "DESCRIPTIO": "灣仔區學校網",
                            "學校數量": "12"
                        },
                        "geometry": {
                            "type": "Polygon",
                            "coordinates": [[
                                [114.17, 22.27], [114.18, 22.27], 
                                [114.18, 22.28], [114.17, 22.28], 
                                [114.17, 22.27]
                            ]]
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "SCHOOLNET": "31",
                            "DISTRICT": "油尖旺區",
                            "DESCRIPTIO": "油尖旺區學校網",
                            "學校數量": "18"
                        },
                        "geometry": {
                            "type": "Point",
                            "coordinates": [114.1694, 22.3193]
                        }
                    }
                ]
            };
            
            wfsLayer.clearLayers();
            wfsLayer.addData(sampleData);
            $('#featureCount').text('3');
            $('#liveFeatureCount').html('<i class="fas fa-info-circle" style="color: #f39c12;"></i> 使用示範數據 (3個學校網)');
        }
        
        // 手風琴功能
        $(document).ready(function() {
            // 初始化手風琴行為
            $('.accordion-header').on('click', function() {
                var section = $(this).data('section');
                var content = $('#' + section + 'Content');
                
                // 切換活動類
                $(this).toggleClass('active');
                $(this).find('.fa-chevron-down').toggleClass('fa-chevron-up');
                
                // 切換內容
                content.toggleClass('open');
            });
            
            // 底圖單選按鈕
            $('input[name="baseMap"]').on('change', function() {
                if ($('#osmMap').is(':checked')) {
                    map.removeLayer(topoLayer);
                    osmLayer.addTo(map);
                } else if ($('#topoMap').is(':checked')) {
                    map.removeLayer(osmLayer);
                    topoLayer.addTo(map);
                }
            });
            
            // WFS圖層複選框
            $('#wfsLayer').on('change', function() {
                if ($(this).is(':checked')) {
                    map.addLayer(wfsLayer);
                } else {
                    map.removeLayer(wfsLayer);
                }
            });
            
            // 透明度滑塊
            $('#opacitySlider').on('input', function() {
                var opacity = $(this).val();
                $('#opacityValue').text(opacity);
                
                // 更新圖層透明度
                wfsLayer.setStyle({
                    fillOpacity: opacity * 0.3,
                    opacity: opacity
                });
                
                // 更新現有圖層
                wfsLayer.eachLayer(function(layer) {
                    if (layer.setStyle) {
                        layer.setStyle({
                            fillOpacity: opacity * 0.3,
                            opacity: opacity
                        });
                    }
                });
            });
            
            // 最大要素選擇器
            $('#maxFeatures').on('change', function() {
                var maxFeatures = $(this).val();
                var newUrl = currentWfsUrl.replace(/maxFeatures=\d+/, 'maxFeatures=' + maxFeatures);
                
                // 如果參數不存在，添加它
                if (currentWfsUrl.indexOf('maxFeatures=') === -1) {
                    newUrl = currentWfsUrl + '&maxFeatures=' + maxFeatures;
                }
                
                currentWfsUrl = newUrl;
                fetchWFSData(currentWfsUrl);
            });
            
            // 地圖控制按鈕
            $('#zoomToData').on('click', function() {
                if (wfsLayer.getLayers().length > 0) {
                    map.fitBounds(wfsLayer.getBounds());
                } else {
                    alert('暫無數據可供縮放。');
                }
            });
            
            $('#refreshData').on('click', function() {
                fetchWFSData(currentWfsUrl);
            });
            
            $('#toggleLegend').on('click', function() {
                $('.map-info').fadeToggle();
            });
            
            // 地圖樣式選擇器
            $('#mapStyle').on('change', function() {
                var style = $(this).val();
                
                // 移除所有瓦片圖層
                map.eachLayer(function(layer) {
                    if (layer instanceof L.TileLayer) {
                        map.removeLayer(layer);
                    }
                });
                
                // 添加選定的底圖
                if ($('#osmMap').is(':checked')) {
                    if (style === 'dark') {
                        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                            attribution: '© OpenStreetMap 貢獻者, © CARTO'
                        }).addTo(map);
                    } else if (style === 'satellite') {
                        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                            attribution: '瓦片 © Esri'
                        }).addTo(map);
                    } else {
                        osmLayer.addTo(map);
                    }
                } else {
                    topoLayer.addTo(map);
                }
                
                // 如果WFS圖層被選中，重新添加
                if ($('#wfsLayer').is(':checked')) {
                    wfsLayer.addTo(map);
                }
            });
            
            // 初始數據獲取
            fetchWFSData(currentWfsUrl);
        });
    </script>
</body>
</html>
